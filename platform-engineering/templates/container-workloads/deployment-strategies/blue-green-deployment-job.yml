# Template for a blue/green deployment with optional manual swap

parameters:
  - name: productName
    type: string
  - name: deployEnvironmentName
    type: string
  - name: deployStepsTemplate
    type: string
  - name: deployStepsParameters
    type: object
    default: {}
  - name: swapMode
    type: string
    default: Automatic
    values:
      - Automatic
      - Manual
  - name: validationWaitMinutes
    type: number
    default: 5

jobs:
  - deployment: BlueGreenDeploy
    displayName: "üü¶üü© Blue-Green ‚Äì ${{ parameters.productName }}"
    environment: ${{ parameters.deployEnvironmentName }}
    strategy:
      runOnce:
        preDeploy:
          steps:
            - script: |
                echo "Provisioning green environment for ${{ parameters.productName }}"
              displayName: "‚ÑπÔ∏è ${{ parameters.productName }} ‚Äì prep green"

        deploy:
          steps:
            - script: |
                echo "Deploying release to green slot for ${{ parameters.productName }}"
              displayName: "üöÄ ${{ parameters.productName }} ‚Äì deploy to green"

            - template: ${{ parameters.deployStepsTemplate }}
              parameters: ${{ parameters.deployStepsParameters }}

        routeTraffic:
          steps:
            - script: |
                echo "Waiting ${{ parameters.validationWaitMinutes }} minutes before swapping traffic"
              displayName: "‚è±Ô∏è ${{ parameters.productName }} ‚Äì stabilize"

            - ${{ if eq(parameters.swapMode, 'Automatic') }}:
              - script: |
                  echo "Automatically swapping traffic to green for ${{ parameters.productName }}"
                displayName: "üîÅ ${{ parameters.productName }} ‚Äì auto swap"
            - ${{ if eq(parameters.swapMode, 'Manual') }}:
              - script: |
                  echo "Manual swap required. Approver must confirm before routing users to green for ${{ parameters.productName }}"
                displayName: "‚úã ${{ parameters.productName }} ‚Äì manual gate"

        postRouteTraffic:
          steps:
            - script: |
                echo "Decommissioning previous blue version for ${{ parameters.productName }}"
              displayName: "üßπ ${{ parameters.productName }} ‚Äì clean up"

        on:
          success:
            steps:
              - script: |
                  echo "Blue/Green deployment finished for ${{ parameters.productName }}"
                displayName: "‚úÖ ${{ parameters.productName }} ‚Äì success"
          failure:
            steps:
              - script: |
                  echo "Blue/Green deployment failed for ${{ parameters.productName }}. Please investigate before swapping traffic."
                displayName: "‚ö†Ô∏è ${{ parameters.productName }} ‚Äì failure"
