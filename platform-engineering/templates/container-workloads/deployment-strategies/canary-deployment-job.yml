# Template for a multi-phase canary deployment

parameters:
  - name: productName
    type: string
  - name: deployEnvironmentName
    type: string
  - name: deployStepsTemplate
    type: string
  - name: deployStepsParameters
    type: object
    default: {}
  - name: canaryIncrements
    type: object
    default:
      - 25
      - 50
  - name: stabilizationMinutes
    type: number
    default: 15
  - name: strategyMode
    type: string
    default: Simulated
    values:
      - Simulated
      - Native

jobs:
  - deployment: CanaryDeploy
    displayName: "üïäÔ∏è Canary ‚Äì ${{ parameters.productName }}"
    environment: ${{ parameters.deployEnvironmentName }}
    strategy:
      ${{ if eq(parameters.strategyMode, 'Native') }}:
        canary:
          increments: ${{ parameters.canaryIncrements }}
          preDeploy:
            steps:
              - script: |
                  echo "Preparing canary deployment for ${{ parameters.productName }}"
                  echo "Target environment: ${{ parameters.deployEnvironmentName }}"
                displayName: "‚ÑπÔ∏è ${{ parameters.productName }} ‚Äì pre-deploy"

          deploy:
            steps:
              - script: |
                  echo "Deploying canary artifacts for ${{ parameters.productName }}"
                displayName: "üöÄ ${{ parameters.productName }} ‚Äì push canary"

              - template: ${{ parameters.deployStepsTemplate }}
                parameters: ${{ parameters.deployStepsParameters }}

          routeTraffic:
            steps:
              - script: |
                  echo "Monitoring native canary increments for ${{ parameters.productName }}"
                  echo "Waiting ${{ parameters.stabilizationMinutes }} minutes between increments"
                displayName: "üîÄ ${{ parameters.productName }} ‚Äì route traffic"

          postRouteTraffic:
            steps:
              - script: |
                  echo "Promoting canary to full production for ${{ parameters.productName }}"
                displayName: "‚¨ÜÔ∏è ${{ parameters.productName }} ‚Äì promote"

              - template: ${{ parameters.deployStepsTemplate }}
                parameters: ${{ parameters.deployStepsParameters }}

          on:
            failure:
              steps:
                - script: |
                    echo "Canary deployment failed for ${{ parameters.productName }}. Initiating rollback."
                  displayName: "‚ö†Ô∏è ${{ parameters.productName }} ‚Äì rollback"
            success:
              steps:
                - script: |
                    echo "Canary deployment completed successfully for ${{ parameters.productName }}"
                  displayName: "‚úÖ ${{ parameters.productName }} ‚Äì success"

      ${{ if ne(parameters.strategyMode, 'Native') }}:
        runOnce:
          preDeploy:
            steps:
              - script: |
                  echo "Preparing simulated canary deployment for ${{ parameters.productName }}"
                  echo "Target environment: ${{ parameters.deployEnvironmentName }}"
                displayName: "‚ÑπÔ∏è ${{ parameters.productName }} ‚Äì pre-deploy"

          deploy:
            steps:
              - script: |
                  echo "Deploying canary artifacts for ${{ parameters.productName }}"
                displayName: "üöÄ ${{ parameters.productName }} ‚Äì push canary"

              - template: ${{ parameters.deployStepsTemplate }}
                parameters: ${{ parameters.deployStepsParameters }}

          routeTraffic:
            steps:
              - script: |
                  echo "Simulating traffic ramp with stabilization windows of ${{ parameters.stabilizationMinutes }} minutes"
                displayName: "üîÅ ${{ parameters.productName }} ‚Äì plan increments"

              - ${{ each inc in parameters.canaryIncrements }}:
                - script: |
                    echo "Routing approximately ${{ inc }}% traffic to canary for ${{ parameters.productName }}"
                    echo "Waiting ${{ parameters.stabilizationMinutes }} minutes before next increment"
                  displayName: "üîÄ ${{ parameters.productName }} ‚Äì ramp to ${{ inc }}%"

          postRouteTraffic:
            steps:
              - script: |
                  echo "Promoting simulated canary to full production for ${{ parameters.productName }}"
                displayName: "‚¨ÜÔ∏è ${{ parameters.productName }} ‚Äì promote"

              - template: ${{ parameters.deployStepsTemplate }}
                parameters: ${{ parameters.deployStepsParameters }}

          on:
            failure:
              steps:
                - script: |
                    echo "Simulated canary deployment failed for ${{ parameters.productName }}. Initiating rollback."
                  displayName: "‚ö†Ô∏è ${{ parameters.productName }} ‚Äì rollback"
            success:
              steps:
                - script: |
                    echo "Simulated canary deployment completed successfully for ${{ parameters.productName }}"
                  displayName: "‚úÖ ${{ parameters.productName }} ‚Äì success"
