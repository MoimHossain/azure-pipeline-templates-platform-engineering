# Template for a multi-phase canary deployment

parameters:
  - name: productName
    type: string
  - name: deployEnvironmentName
    type: string
  - name: deployStepsTemplate
    type: string
  - name: deployStepsParameters
    type: object
    default: {}
  - name: preDeployStepsTemplate
    type: string
    default: ""
  - name: preDeployStepsParameters
    type: object
    default: {}
  - name: routeTrafficStepsTemplate
    type: string
    default: ""
  - name: routeTrafficStepsParameters
    type: object
    default: {}
  - name: postRouteTrafficStepsTemplate
    type: string
    default: ""
  - name: postRouteTrafficStepsParameters
    type: object
    default: {}
  - name: successStepsTemplate
    type: string
    default: ""
  - name: successStepsParameters
    type: object
    default: {}
  - name: healthCheckStepsTemplate
    type: string
    default: ""
  - name: healthCheckStepsParameters
    type: object
    default: {}
  - name: failureStepsTemplate
    type: string
    default: ""
  - name: failureStepsParameters
    type: object
    default: {}
  - name: canaryIncrements
    type: object
    default:
      CanaryStep_0: 25
      CanaryStep_1: 50
  - name: nativeCanaryIncrements
    type: object
    default:
      - 25
      - 50
  - name: canaryStepDependencyMap
    type: object
    default:
      CanaryStep_0: CanaryPreDeploy
      CanaryStep_1: CanaryStep_0
      CanaryStep_2: CanaryStep_1
      CanaryStep_3: CanaryStep_2
      CanaryStep_4: CanaryStep_3
      CanaryStep_5: CanaryStep_4
      CanaryStep_6: CanaryStep_5
      CanaryStep_7: CanaryStep_6
      CanaryStep_8: CanaryStep_7
      CanaryStep_9: CanaryStep_8
      CanaryStep_10: CanaryStep_9
      CanaryStep_11: CanaryStep_10
      CanaryStep_12: CanaryStep_11
      CanaryStep_13: CanaryStep_12
      CanaryStep_14: CanaryStep_13
      CanaryStep_15: CanaryStep_14
      CanaryStep_16: CanaryStep_15
      CanaryStep_17: CanaryStep_16
      CanaryStep_18: CanaryStep_17
  - name: stabilizationSeconds
    type: number
    default: 900
  - name: strategyMode
    type: string
    default: Orchestrated
    values:
      - Orchestrated
      - Native

jobs:
  - ${{ if eq(parameters.strategyMode, 'Native') }}:
    - deployment: CanaryNative
      displayName: "üïäÔ∏è Canary (native) ‚Äì ${{ parameters.productName }}"
      environment: ${{ parameters.deployEnvironmentName }}
      strategy:
        canary:
          increments: ${{ parameters.nativeCanaryIncrements }}
          preDeploy:
            steps:
              - ${{ if ne(parameters.preDeployStepsTemplate, '') }}:
                - template: ${{ parameters.preDeployStepsTemplate }}
                  parameters:
                    stage: preDeploy
                    productName: ${{ parameters.productName }}
                    deployEnvironmentName: ${{ parameters.deployEnvironmentName }}
                    ${{ each pair in parameters.preDeployStepsParameters }}:
                      ${{ pair.key }}: ${{ pair.value }}
              - ${{ if eq(parameters.preDeployStepsTemplate, '') }}:
                - script: |
                    echo "Preparing canary deployment for ${{ parameters.productName }}"
                    echo "Target environment: ${{ parameters.deployEnvironmentName }}"
                  displayName: "‚ÑπÔ∏è ${{ parameters.productName }} ‚Äì pre-deploy"

          deploy:
            steps:
              - ${{ if ne(parameters.deployStepsTemplate, '') }}:
                - template: ${{ parameters.deployStepsTemplate }}
                  parameters:
                    productName: ${{ parameters.productName }}
                    deployEnvironmentName: ${{ parameters.deployEnvironmentName }}
                    stage: deploy
                    incrementPercent: 0
                    ${{ each pair in parameters.deployStepsParameters }}:
                      ${{ pair.key }}: ${{ pair.value }}
              - ${{ if eq(parameters.deployStepsTemplate, '') }}:
                - script: |
                    echo "Deploying canary artifacts for ${{ parameters.productName }}"
                  displayName: "üöÄ ${{ parameters.productName }} ‚Äì push canary"

          routeTraffic:
            steps:
              - ${{ if ne(parameters.routeTrafficStepsTemplate, '') }}:
                - template: ${{ parameters.routeTrafficStepsTemplate }}
                  parameters:
                    productName: ${{ parameters.productName }}
                    deployEnvironmentName: ${{ parameters.deployEnvironmentName }}
                    stage: routeTraffic
                    incrementPercent: 0
                    ${{ each pair in parameters.routeTrafficStepsParameters }}:
                      ${{ pair.key }}: ${{ pair.value }}
              - ${{ if eq(parameters.routeTrafficStepsTemplate, '') }}:
                - script: |
                    echo "Monitoring native canary increments for ${{ parameters.productName }}"
                    echo "Routing traffic using native canary increments"
                  displayName: "üîÄ ${{ parameters.productName }} ‚Äì route traffic"

              - pwsh: |
                  $seconds = $env:STABILIZATION_SECONDS -as [int]
                  if ($seconds -le 0) { $seconds = 1 }
                  Write-Host "Holding steady for $seconds seconds before health checks"
                  Start-Sleep -Seconds $seconds
                displayName: "‚è±Ô∏è ${{ parameters.productName }} ‚Äì stabilize"
                env:
                  STABILIZATION_SECONDS: ${{ parameters.stabilizationSeconds }}

              - ${{ if ne(parameters.healthCheckStepsTemplate, '') }}:
                - template: ${{ parameters.healthCheckStepsTemplate }}
                  parameters:
                    productName: ${{ parameters.productName }}
                    deployEnvironmentName: ${{ parameters.deployEnvironmentName }}
                    stage: healthCheck
                    incrementPercent: 0
                    ${{ each pair in parameters.healthCheckStepsParameters }}:
                      ${{ pair.key }}: ${{ pair.value }}
              - ${{ if eq(parameters.healthCheckStepsTemplate, '') }}:
                - script: |
                    echo "Health check placeholder for ${{ parameters.productName }} (native mode)"
                  displayName: "ü©∫ ${{ parameters.productName }} ‚Äì health check"

          postRouteTraffic:
            steps:
              - ${{ if ne(parameters.postRouteTrafficStepsTemplate, '') }}:
                - template: ${{ parameters.postRouteTrafficStepsTemplate }}
                  parameters:
                    productName: ${{ parameters.productName }}
                    deployEnvironmentName: ${{ parameters.deployEnvironmentName }}
                    stage: postRouteTraffic
                    ${{ each pair in parameters.postRouteTrafficStepsParameters }}:
                      ${{ pair.key }}: ${{ pair.value }}
              - ${{ if eq(parameters.postRouteTrafficStepsTemplate, '') }}:
                - script: |
                    echo "Promoting canary to full production for ${{ parameters.productName }}"
                  displayName: "‚¨ÜÔ∏è ${{ parameters.productName }} ‚Äì promote"

              - ${{ if ne(parameters.deployStepsTemplate, '') }}:
                - template: ${{ parameters.deployStepsTemplate }}
                  parameters:
                    productName: ${{ parameters.productName }}
                    deployEnvironmentName: ${{ parameters.deployEnvironmentName }}
                    stage: postRouteTraffic
                    incrementPercent: 100
                    ${{ each pair in parameters.deployStepsParameters }}:
                      ${{ pair.key }}: ${{ pair.value }}

          on:
            failure:
              steps:
                - ${{ if ne(parameters.failureStepsTemplate, '') }}:
                  - template: ${{ parameters.failureStepsTemplate }}
                    parameters:
                      productName: ${{ parameters.productName }}
                      deployEnvironmentName: ${{ parameters.deployEnvironmentName }}
                      stage: failure
                      ${{ each pair in parameters.failureStepsParameters }}:
                        ${{ pair.key }}: ${{ pair.value }}
                - ${{ if eq(parameters.failureStepsTemplate, '') }}:
                  - script: |
                      echo "Canary deployment failed for ${{ parameters.productName }}. Initiating rollback."
                    displayName: "‚ö†Ô∏è ${{ parameters.productName }} ‚Äì rollback"
            success:
              steps:
                - ${{ if ne(parameters.successStepsTemplate, '') }}:
                  - template: ${{ parameters.successStepsTemplate }}
                    parameters:
                      productName: ${{ parameters.productName }}
                      deployEnvironmentName: ${{ parameters.deployEnvironmentName }}
                      stage: success
                      ${{ each pair in parameters.successStepsParameters }}:
                        ${{ pair.key }}: ${{ pair.value }}
                - ${{ if eq(parameters.successStepsTemplate, '') }}:
                  - script: |
                      echo "Canary deployment completed successfully for ${{ parameters.productName }}"
                    displayName: "‚úÖ ${{ parameters.productName }} ‚Äì success"

  - ${{ if ne(parameters.strategyMode, 'Native') }}:
    - deployment: CanaryPreDeploy
      displayName: "üïäÔ∏è Canary pre-deploy ‚Äì ${{ parameters.productName }}"
      environment: ${{ parameters.deployEnvironmentName }}
      strategy:
        runOnce:
          deploy:
            steps:
              - ${{ if ne(parameters.preDeployStepsTemplate, '') }}:
                - template: ${{ parameters.preDeployStepsTemplate }}
                  parameters:
                    stage: preDeploy
                    productName: ${{ parameters.productName }}
                    deployEnvironmentName: ${{ parameters.deployEnvironmentName }}
                    ${{ each pair in parameters.preDeployStepsParameters }}:
                      ${{ pair.key }}: ${{ pair.value }}
              - ${{ if eq(parameters.preDeployStepsTemplate, '') }}:
                - script: |
                    echo "Preparing canary deployment for ${{ parameters.productName }}"
                    echo "Target environment: ${{ parameters.deployEnvironmentName }}"
                  displayName: "‚ÑπÔ∏è ${{ parameters.productName }} ‚Äì pre-deploy"

    - ${{ each inc in parameters.canaryIncrements }}:
      - deployment: ${{ inc.key }}
        displayName: "üïäÔ∏è Canary step ${{ inc.value }}% ‚Äì ${{ parameters.productName }}"
        dependsOn: ${{ coalesce(parameters.canaryStepDependencyMap[inc.key], 'CanaryPreDeploy') }}
        environment: ${{ parameters.deployEnvironmentName }}
        strategy:
          runOnce:
            deploy:
              steps:
                - ${{ if ne(parameters.deployStepsTemplate, '') }}:
                  - template: ${{ parameters.deployStepsTemplate }}
                    parameters:
                      productName: ${{ parameters.productName }}
                      deployEnvironmentName: ${{ parameters.deployEnvironmentName }}
                      stage: deploy
                      incrementPercent: ${{ inc.value }}
                      ${{ each pair in parameters.deployStepsParameters }}:
                        ${{ pair.key }}: ${{ pair.value }}
                - ${{ if eq(parameters.deployStepsTemplate, '') }}:
                  - script: |
                      echo "Deploying canary artifacts for ${{ parameters.productName }} at ${{ inc.value }}%"
                    displayName: "üöÄ ${{ parameters.productName }} ‚Äì push ${{ inc.value }}%"

                - ${{ if ne(parameters.routeTrafficStepsTemplate, '') }}:
                  - template: ${{ parameters.routeTrafficStepsTemplate }}
                    parameters:
                      productName: ${{ parameters.productName }}
                      deployEnvironmentName: ${{ parameters.deployEnvironmentName }}
                      stage: routeTraffic
                      incrementPercent: ${{ inc.value }}
                      ${{ each pair in parameters.routeTrafficStepsParameters }}:
                        ${{ pair.key }}: ${{ pair.value }}
                - ${{ if eq(parameters.routeTrafficStepsTemplate, '') }}:
                  - script: |
                      echo "Routing approximately ${{ inc.value }}% traffic for ${{ parameters.productName }}"
                    displayName: "üîÄ ${{ parameters.productName }} ‚Äì ramp to ${{ inc.value }}%"

                - pwsh: |
                    $seconds = $env:STABILIZATION_SECONDS -as [int]
                    if ($seconds -le 0) { $seconds = 1 }
                    Write-Host "Holding steady for $seconds seconds before next increment"
                    Start-Sleep -Seconds $seconds
                  displayName: "‚è±Ô∏è ${{ parameters.productName }} ‚Äì stabilize"
                  env:
                    STABILIZATION_SECONDS: ${{ parameters.stabilizationSeconds }}

                - ${{ if ne(parameters.healthCheckStepsTemplate, '') }}:
                  - template: ${{ parameters.healthCheckStepsTemplate }}
                    parameters:
                      productName: ${{ parameters.productName }}
                      deployEnvironmentName: ${{ parameters.deployEnvironmentName }}
                      stage: healthCheck
                      incrementPercent: ${{ inc.value }}
                      ${{ each pair in parameters.healthCheckStepsParameters }}:
                        ${{ pair.key }}: ${{ pair.value }}
                - ${{ if eq(parameters.healthCheckStepsTemplate, '') }}:
                  - script: |
                      echo "Health check placeholder for ${{ parameters.productName }} at ${{ inc.value }}%"
                    displayName: "ü©∫ ${{ parameters.productName }} ‚Äì health check"

    - deployment: CanaryFinal
      displayName: "üïäÔ∏è Canary finalize 100% ‚Äì ${{ parameters.productName }}"
      dependsOn:
        - CanaryPreDeploy
        - ${{ each inc in parameters.canaryIncrements }}:
          - ${{ inc.key }}
      environment: ${{ parameters.deployEnvironmentName }}
      strategy:
        runOnce:
          deploy:
            steps:
              - ${{ if ne(parameters.deployStepsTemplate, '') }}:
                - template: ${{ parameters.deployStepsTemplate }}
                  parameters:
                    productName: ${{ parameters.productName }}
                    deployEnvironmentName: ${{ parameters.deployEnvironmentName }}
                    stage: deploy
                    incrementPercent: 100
                    ${{ each pair in parameters.deployStepsParameters }}:
                      ${{ pair.key }}: ${{ pair.value }}
              - ${{ if eq(parameters.deployStepsTemplate, '') }}:
                - script: |
                    echo "Routing 100% of traffic for ${{ parameters.productName }}"
                    echo "Target environment: ${{ parameters.deployEnvironmentName }}"
                  displayName: "üîÅ ${{ parameters.productName }} ‚Äì full traffic"

              - ${{ if ne(parameters.routeTrafficStepsTemplate, '') }}:
                - template: ${{ parameters.routeTrafficStepsTemplate }}
                  parameters:
                    productName: ${{ parameters.productName }}
                    deployEnvironmentName: ${{ parameters.deployEnvironmentName }}
                    stage: routeTraffic
                    incrementPercent: 100
                    ${{ each pair in parameters.routeTrafficStepsParameters }}:
                      ${{ pair.key }}: ${{ pair.value }}
              - ${{ if eq(parameters.routeTrafficStepsTemplate, '') }}:
                - script: |
                    echo "Promoting canary to 100% traffic for ${{ parameters.productName }}"
                  displayName: "‚¨ÜÔ∏è ${{ parameters.productName }} ‚Äì promote"

              - pwsh: |
                  $seconds = $env:STABILIZATION_SECONDS -as [int]
                  if ($seconds -le 0) { $seconds = 1 }
                  Write-Host "Holding steady for $seconds seconds before health checks"
                  Start-Sleep -Seconds $seconds
                displayName: "‚è±Ô∏è ${{ parameters.productName }} ‚Äì stabilize"
                env:
                  STABILIZATION_SECONDS: ${{ parameters.stabilizationSeconds }}

              - ${{ if ne(parameters.healthCheckStepsTemplate, '') }}:
                - template: ${{ parameters.healthCheckStepsTemplate }}
                  parameters:
                    productName: ${{ parameters.productName }}
                    deployEnvironmentName: ${{ parameters.deployEnvironmentName }}
                    stage: healthCheck
                    incrementPercent: 100
                    ${{ each pair in parameters.healthCheckStepsParameters }}:
                      ${{ pair.key }}: ${{ pair.value }}
              - ${{ if eq(parameters.healthCheckStepsTemplate, '') }}:
                - script: |
                    echo "Health check placeholder for ${{ parameters.productName }} at 100%"
                  displayName: "ü©∫ ${{ parameters.productName }} ‚Äì health check"

    - deployment: CanaryPostRoute
      displayName: "üïäÔ∏è Canary post-route ‚Äì ${{ parameters.productName }}"
      dependsOn: CanaryFinal
      environment: ${{ parameters.deployEnvironmentName }}
      strategy:
        runOnce:
          deploy:
            steps:
              - ${{ if ne(parameters.postRouteTrafficStepsTemplate, '') }}:
                - template: ${{ parameters.postRouteTrafficStepsTemplate }}
                  parameters:
                    productName: ${{ parameters.productName }}
                    deployEnvironmentName: ${{ parameters.deployEnvironmentName }}
                    stage: postRouteTraffic
                    ${{ each pair in parameters.postRouteTrafficStepsParameters }}:
                      ${{ pair.key }}: ${{ pair.value }}
              - ${{ if eq(parameters.postRouteTrafficStepsTemplate, '') }}:
                - script: |
                    echo "Post-route validation for ${{ parameters.productName }}"
                  displayName: "üìã ${{ parameters.productName }} ‚Äì post-route"

    - job: CanarySuccess
      displayName: "üïäÔ∏è Canary success ‚Äì ${{ parameters.productName }}"
      dependsOn: CanaryPostRoute
      condition: succeeded('CanaryPostRoute')
      steps:
        - ${{ if ne(parameters.successStepsTemplate, '') }}:
          - template: ${{ parameters.successStepsTemplate }}
            parameters:
              productName: ${{ parameters.productName }}
              deployEnvironmentName: ${{ parameters.deployEnvironmentName }}
              stage: success
              ${{ each pair in parameters.successStepsParameters }}:
                ${{ pair.key }}: ${{ pair.value }}
        - ${{ if eq(parameters.successStepsTemplate, '') }}:
          - script: |
              echo "Canary deployment completed successfully for ${{ parameters.productName }}"
            displayName: "‚úÖ ${{ parameters.productName }} ‚Äì success"

    - job: CanaryFailure
      displayName: "üïäÔ∏è Canary failure ‚Äì ${{ parameters.productName }}"
      dependsOn: CanaryPostRoute
      condition: failed()
      steps:
        - ${{ if ne(parameters.failureStepsTemplate, '') }}:
          - template: ${{ parameters.failureStepsTemplate }}
            parameters:
              productName: ${{ parameters.productName }}
              deployEnvironmentName: ${{ parameters.deployEnvironmentName }}
              stage: failure
              ${{ each pair in parameters.failureStepsParameters }}:
                ${{ pair.key }}: ${{ pair.value }}
        - ${{ if eq(parameters.failureStepsTemplate, '') }}:
          - script: |
              echo "Canary deployment failed for ${{ parameters.productName }}. Initiating rollback."
            displayName: "‚ö†Ô∏è ${{ parameters.productName }} ‚Äì rollback"
