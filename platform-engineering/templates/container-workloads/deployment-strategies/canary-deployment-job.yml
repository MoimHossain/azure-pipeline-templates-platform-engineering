# Template for a multi-phase canary deployment

parameters:
  - name: productName
    type: string
  - name: deployEnvironmentName
    type: string
  - name: deployStepsTemplate
    type: string
  - name: deployStepsParameters
    type: object
    default: {}
  - name: canaryIncrements
    type: object
    default:
      - 25
      - 50
  - name: stabilizationMinutes
    type: number
    default: 15

jobs:
  - deployment: CanaryDeploy
    displayName: "ğŸ•Šï¸ Canary â€“ ${{ parameters.productName }}"
    environment: ${{ parameters.deployEnvironmentName }}
    strategy:
      canary:
        increments: ${{ parameters.canaryIncrements }}
        preDeploy:
          steps:
            - script: |
                echo "Preparing canary deployment for ${{ parameters.productName }}"
                echo "Target environment: ${{ parameters.deployEnvironmentName }}"
              displayName: "â„¹ï¸ ${{ parameters.productName }} â€“ pre-deploy"

        deploy:
          steps:
            - script: |
                echo "Deploying canary artifacts for ${{ parameters.productName }}"
              displayName: "ğŸš€ ${{ parameters.productName }} â€“ push canary"

            - template: ${{ parameters.deployStepsTemplate }}
              parameters: ${{ parameters.deployStepsParameters }}

        routeTraffic:
          steps:
            - script: |
                echo "Monitoring canary increments (${{ join(parameters.canaryIncrements, ',') }}%) for ${{ parameters.productName }}"
                echo "Waiting ${{ parameters.stabilizationMinutes }} minutes between increments"
              displayName: "ğŸ”€ ${{ parameters.productName }} â€“ route traffic"

        postRouteTraffic:
          steps:
            - script: |
                echo "Promoting canary to full production for ${{ parameters.productName }}"
              displayName: "â¬†ï¸ ${{ parameters.productName }} â€“ promote"

            - template: ${{ parameters.deployStepsTemplate }}
              parameters: ${{ parameters.deployStepsParameters }}

        on:
          failure:
            steps:
              - script: |
                  echo "Canary deployment failed for ${{ parameters.productName }}. Initiating rollback."
                displayName: "âš ï¸ ${{ parameters.productName }} â€“ rollback"
          success:
            steps:
              - script: |
                  echo "Canary deployment completed successfully for ${{ parameters.productName }}"
                displayName: "âœ… ${{ parameters.productName }} â€“ success"
