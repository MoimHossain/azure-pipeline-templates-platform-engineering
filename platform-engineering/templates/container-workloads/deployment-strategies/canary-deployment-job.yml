# Template for a multi-phase canary deployment

parameters:
  - name: productName
    type: string
  - name: deployEnvironmentName
    type: string
  - name: deployStepsTemplate
    type: string
  - name: deployStepsParameters
    type: object
    default: {}
  - name: preDeployStepsTemplate
    type: string
    default: ""
  - name: preDeployStepsParameters
    type: object
    default: {}
  - name: routeTrafficStepsTemplate
    type: string
    default: ""
  - name: routeTrafficStepsParameters
    type: object
    default: {}
  - name: postRouteTrafficStepsTemplate
    type: string
    default: ""
  - name: postRouteTrafficStepsParameters
    type: object
    default: {}
  - name: successStepsTemplate
    type: string
    default: ""
  - name: successStepsParameters
    type: object
    default: {}
  - name: failureStepsTemplate
    type: string
    default: ""
  - name: failureStepsParameters
    type: object
    default: {}
  - name: canaryIncrements
    type: object
    default:
      - 25
      - 50
  - name: stabilizationMinutes
    type: number
    default: 15
  - name: strategyMode
    type: string
    default: Orchestrated
    values:
      - Orchestrated
      - Native

jobs:
  - ${{ if eq(parameters.strategyMode, 'Native') }}:
    - deployment: CanaryNative
      displayName: "üïäÔ∏è Canary (native) ‚Äì ${{ parameters.productName }}"
      environment: ${{ parameters.deployEnvironmentName }}
      strategy:
        canary:
          increments: ${{ parameters.canaryIncrements }}
          preDeploy:
            steps:
              - ${{ if ne(parameters.preDeployStepsTemplate, '') }}:
                - template: ${{ parameters.preDeployStepsTemplate }}
                  parameters:
                    stage: preDeploy
                    productName: ${{ parameters.productName }}
                    deployEnvironmentName: ${{ parameters.deployEnvironmentName }}
                    ${{ each pair in parameters.preDeployStepsParameters }}:
                      ${{ pair.key }}: ${{ pair.value }}
              - ${{ if eq(parameters.preDeployStepsTemplate, '') }}:
                - script: |
                    echo "Preparing canary deployment for ${{ parameters.productName }}"
                    echo "Target environment: ${{ parameters.deployEnvironmentName }}"
                  displayName: "‚ÑπÔ∏è ${{ parameters.productName }} ‚Äì pre-deploy"

          deploy:
            steps:
              - ${{ if ne(parameters.deployStepsTemplate, '') }}:
                - template: ${{ parameters.deployStepsTemplate }}
                  parameters:
                    productName: ${{ parameters.productName }}
                    deployEnvironmentName: ${{ parameters.deployEnvironmentName }}
                    stage: deploy
                    incrementPercent: 0
                    ${{ each pair in parameters.deployStepsParameters }}:
                      ${{ pair.key }}: ${{ pair.value }}
              - ${{ if eq(parameters.deployStepsTemplate, '') }}:
                - script: |
                    echo "Deploying canary artifacts for ${{ parameters.productName }}"
                  displayName: "üöÄ ${{ parameters.productName }} ‚Äì push canary"

          routeTraffic:
            steps:
              - ${{ if ne(parameters.routeTrafficStepsTemplate, '') }}:
                - template: ${{ parameters.routeTrafficStepsTemplate }}
                  parameters:
                    productName: ${{ parameters.productName }}
                    deployEnvironmentName: ${{ parameters.deployEnvironmentName }}
                    stage: routeTraffic
                    incrementPercent: 0
                    ${{ each pair in parameters.routeTrafficStepsParameters }}:
                      ${{ pair.key }}: ${{ pair.value }}
              - ${{ if eq(parameters.routeTrafficStepsTemplate, '') }}:
                - script: |
                    echo "Monitoring native canary increments for ${{ parameters.productName }}"
                    echo "Waiting ${{ parameters.stabilizationMinutes }} minutes between increments"
                  displayName: "üîÄ ${{ parameters.productName }} ‚Äì route traffic"

          postRouteTraffic:
            steps:
              - ${{ if ne(parameters.postRouteTrafficStepsTemplate, '') }}:
                - template: ${{ parameters.postRouteTrafficStepsTemplate }}
                  parameters:
                    productName: ${{ parameters.productName }}
                    deployEnvironmentName: ${{ parameters.deployEnvironmentName }}
                    stage: postRouteTraffic
                    ${{ each pair in parameters.postRouteTrafficStepsParameters }}:
                      ${{ pair.key }}: ${{ pair.value }}
              - ${{ if eq(parameters.postRouteTrafficStepsTemplate, '') }}:
                - script: |
                    echo "Promoting canary to full production for ${{ parameters.productName }}"
                  displayName: "‚¨ÜÔ∏è ${{ parameters.productName }} ‚Äì promote"

              - ${{ if ne(parameters.deployStepsTemplate, '') }}:
                - template: ${{ parameters.deployStepsTemplate }}
                  parameters:
                    productName: ${{ parameters.productName }}
                    deployEnvironmentName: ${{ parameters.deployEnvironmentName }}
                    stage: postRouteTraffic
                    incrementPercent: 100
                    ${{ each pair in parameters.deployStepsParameters }}:
                      ${{ pair.key }}: ${{ pair.value }}

          on:
            failure:
              steps:
                - ${{ if ne(parameters.failureStepsTemplate, '') }}:
                  - template: ${{ parameters.failureStepsTemplate }}
                    parameters:
                      productName: ${{ parameters.productName }}
                      deployEnvironmentName: ${{ parameters.deployEnvironmentName }}
                      stage: failure
                      ${{ each pair in parameters.failureStepsParameters }}:
                        ${{ pair.key }}: ${{ pair.value }}
                - ${{ if eq(parameters.failureStepsTemplate, '') }}:
                  - script: |
                      echo "Canary deployment failed for ${{ parameters.productName }}. Initiating rollback."
                    displayName: "‚ö†Ô∏è ${{ parameters.productName }} ‚Äì rollback"
            success:
              steps:
                - ${{ if ne(parameters.successStepsTemplate, '') }}:
                  - template: ${{ parameters.successStepsTemplate }}
                    parameters:
                      productName: ${{ parameters.productName }}
                      deployEnvironmentName: ${{ parameters.deployEnvironmentName }}
                      stage: success
                      ${{ each pair in parameters.successStepsParameters }}:
                        ${{ pair.key }}: ${{ pair.value }}
                - ${{ if eq(parameters.successStepsTemplate, '') }}:
                  - script: |
                      echo "Canary deployment completed successfully for ${{ parameters.productName }}"
                    displayName: "‚úÖ ${{ parameters.productName }} ‚Äì success"

  - ${{ if ne(parameters.strategyMode, 'Native') }}:
    - deployment: CanaryPreDeploy
      displayName: "üïäÔ∏è Canary pre-deploy ‚Äì ${{ parameters.productName }}"
      environment: ${{ parameters.deployEnvironmentName }}
      strategy:
        runOnce:
          deploy:
            steps:
              - ${{ if ne(parameters.preDeployStepsTemplate, '') }}:
                - template: ${{ parameters.preDeployStepsTemplate }}
                  parameters:
                    stage: preDeploy
                    productName: ${{ parameters.productName }}
                    deployEnvironmentName: ${{ parameters.deployEnvironmentName }}
                    ${{ each pair in parameters.preDeployStepsParameters }}:
                      ${{ pair.key }}: ${{ pair.value }}
              - ${{ if eq(parameters.preDeployStepsTemplate, '') }}:
                - script: |
                    echo "Preparing canary deployment for ${{ parameters.productName }}"
                    echo "Target environment: ${{ parameters.deployEnvironmentName }}"
                  displayName: "‚ÑπÔ∏è ${{ parameters.productName }} ‚Äì pre-deploy"

    - ${{ each inc in parameters.canaryIncrements }}:
      - deployment: ${{ format('CanaryStep_{0}', inc.key) }}
        displayName: "üïäÔ∏è Canary step ${{ inc.value }}% ‚Äì ${{ parameters.productName }}"
        ${{ if eq(int(inc.key), 0) }}:
          dependsOn: CanaryPreDeploy
        ${{ if gt(int(inc.key), 0) }}:
          dependsOn: ${{ format('CanaryStep_{0}', sub(int(inc.key), 1)) }}
        environment: ${{ parameters.deployEnvironmentName }}
        strategy:
          runOnce:
            deploy:
              steps:
                - ${{ if ne(parameters.deployStepsTemplate, '') }}:
                  - template: ${{ parameters.deployStepsTemplate }}
                    parameters:
                      productName: ${{ parameters.productName }}
                      deployEnvironmentName: ${{ parameters.deployEnvironmentName }}
                      stage: deploy
                      incrementPercent: ${{ inc.value }}
                      ${{ each pair in parameters.deployStepsParameters }}:
                        ${{ pair.key }}: ${{ pair.value }}
                - ${{ if eq(parameters.deployStepsTemplate, '') }}:
                  - script: |
                      echo "Deploying canary artifacts for ${{ parameters.productName }} at ${{ inc.value }}%"
                    displayName: "üöÄ ${{ parameters.productName }} ‚Äì push ${{ inc.value }}%"

                - ${{ if ne(parameters.routeTrafficStepsTemplate, '') }}:
                  - template: ${{ parameters.routeTrafficStepsTemplate }}
                    parameters:
                      productName: ${{ parameters.productName }}
                      deployEnvironmentName: ${{ parameters.deployEnvironmentName }}
                      stage: routeTraffic
                      incrementPercent: ${{ inc.value }}
                      ${{ each pair in parameters.routeTrafficStepsParameters }}:
                        ${{ pair.key }}: ${{ pair.value }}
                - ${{ if eq(parameters.routeTrafficStepsTemplate, '') }}:
                  - script: |
                      echo "Routing approximately ${{ inc.value }}% traffic for ${{ parameters.productName }}"
                    displayName: "üîÄ ${{ parameters.productName }} ‚Äì ramp to ${{ inc.value }}%"

                - pwsh: |
                    Write-Host "Holding steady for ${{ parameters.stabilizationMinutes }} minutes before next increment"
                    Start-Sleep -Seconds ${{ mul(parameters.stabilizationMinutes, 60) }}
                  displayName: "‚è±Ô∏è ${{ parameters.productName }} ‚Äì stabilize"

    - deployment: CanaryFinal
      displayName: "üïäÔ∏è Canary finalize 100% ‚Äì ${{ parameters.productName }}"
      ${{ if gt(length(parameters.canaryIncrements), 0) }}:
        dependsOn: ${{ format('CanaryStep_{0}', sub(length(parameters.canaryIncrements), 1)) }}
      ${{ if eq(length(parameters.canaryIncrements), 0) }}:
        dependsOn: CanaryPreDeploy
      environment: ${{ parameters.deployEnvironmentName }}
      strategy:
        runOnce:
          deploy:
            steps:
              - ${{ if ne(parameters.deployStepsTemplate, '') }}:
                - template: ${{ parameters.deployStepsTemplate }}
                  parameters:
                    productName: ${{ parameters.productName }}
                    deployEnvironmentName: ${{ parameters.deployEnvironmentName }}
                    stage: deploy
                    incrementPercent: 100
                    ${{ each pair in parameters.deployStepsParameters }}:
                      ${{ pair.key }}: ${{ pair.value }}
              - ${{ if eq(parameters.deployStepsTemplate, '') }}:
                - script: |
                    echo "Routing 100% of traffic for ${{ parameters.productName }}"
                    echo "Target environment: ${{ parameters.deployEnvironmentName }}"
                  displayName: "üîÅ ${{ parameters.productName }} ‚Äì full traffic"

              - ${{ if ne(parameters.routeTrafficStepsTemplate, '') }}:
                - template: ${{ parameters.routeTrafficStepsTemplate }}
                  parameters:
                    productName: ${{ parameters.productName }}
                    deployEnvironmentName: ${{ parameters.deployEnvironmentName }}
                    stage: routeTraffic
                    incrementPercent: 100
                    ${{ each pair in parameters.routeTrafficStepsParameters }}:
                      ${{ pair.key }}: ${{ pair.value }}
              - ${{ if eq(parameters.routeTrafficStepsTemplate, '') }}:
                - script: |
                    echo "Promoting canary to 100% traffic for ${{ parameters.productName }}"
                  displayName: "‚¨ÜÔ∏è ${{ parameters.productName }} ‚Äì promote"

    - deployment: CanaryPostRoute
      displayName: "üïäÔ∏è Canary post-route ‚Äì ${{ parameters.productName }}"
      dependsOn: CanaryFinal
      environment: ${{ parameters.deployEnvironmentName }}
      strategy:
        runOnce:
          deploy:
            steps:
              - ${{ if ne(parameters.postRouteTrafficStepsTemplate, '') }}:
                - template: ${{ parameters.postRouteTrafficStepsTemplate }}
                  parameters:
                    productName: ${{ parameters.productName }}
                    deployEnvironmentName: ${{ parameters.deployEnvironmentName }}
                    stage: postRouteTraffic
                    ${{ each pair in parameters.postRouteTrafficStepsParameters }}:
                      ${{ pair.key }}: ${{ pair.value }}
              - ${{ if eq(parameters.postRouteTrafficStepsTemplate, '') }}:
                - script: |
                    echo "Post-route validation for ${{ parameters.productName }}"
                  displayName: "üìã ${{ parameters.productName }} ‚Äì post-route"

    - job: CanarySuccess
      displayName: "üïäÔ∏è Canary success ‚Äì ${{ parameters.productName }}"
      dependsOn: CanaryPostRoute
      condition: succeeded('CanaryPostRoute')
      steps:
        - ${{ if ne(parameters.successStepsTemplate, '') }}:
          - template: ${{ parameters.successStepsTemplate }}
            parameters:
              productName: ${{ parameters.productName }}
              deployEnvironmentName: ${{ parameters.deployEnvironmentName }}
              stage: success
              ${{ each pair in parameters.successStepsParameters }}:
                ${{ pair.key }}: ${{ pair.value }}
        - ${{ if eq(parameters.successStepsTemplate, '') }}:
          - script: |
              echo "Canary deployment completed successfully for ${{ parameters.productName }}"
            displayName: "‚úÖ ${{ parameters.productName }} ‚Äì success"

    - job: CanaryFailure
      displayName: "üïäÔ∏è Canary failure ‚Äì ${{ parameters.productName }}"
      dependsOn: CanaryPostRoute
      condition: failed()
      steps:
        - ${{ if ne(parameters.failureStepsTemplate, '') }}:
          - template: ${{ parameters.failureStepsTemplate }}
            parameters:
              productName: ${{ parameters.productName }}
              deployEnvironmentName: ${{ parameters.deployEnvironmentName }}
              stage: failure
              ${{ each pair in parameters.failureStepsParameters }}:
                ${{ pair.key }}: ${{ pair.value }}
        - ${{ if eq(parameters.failureStepsTemplate, '') }}:
          - script: |
              echo "Canary deployment failed for ${{ parameters.productName }}. Initiating rollback."
            displayName: "‚ö†Ô∏è ${{ parameters.productName }} ‚Äì rollback"
