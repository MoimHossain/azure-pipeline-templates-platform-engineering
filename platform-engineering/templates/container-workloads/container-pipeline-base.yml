parameters:
  - name: productName
    type: string
  - name: imageName
    type: string
  - name: deployEnvironmentName
    type: string
  - name: containerDeploymentStrategy
    type: string
    default: Rolling
    values:
      - Rolling
      - Canary
      - BlueGreen
  - name: buildStepsTemplate
    type: string
    default: /templates/container-workloads/container-build-steps.yml
  - name: buildStepsParameters
    type: object
    default: {}
  - name: deployStepsTemplate
    type: string
    default: /templates/container-workloads/container-app-simple-deploy-steps.yml
  - name: deployStepsParameters
    type: object
    default: {}
  - name: canaryIncrements
    type: object
    default:
      CanaryStep_0: 25
      CanaryStep_1: 50
  - name: nativeCanaryIncrements
    type: object
    default:
      - 25
      - 50
  - name: canaryStepDependencyMap
    type: object
    default:
      CanaryStep_0: CanaryPreDeploy
      CanaryStep_1: CanaryStep_0
      CanaryStep_2: CanaryStep_1
      CanaryStep_3: CanaryStep_2
      CanaryStep_4: CanaryStep_3
      CanaryStep_5: CanaryStep_4
      CanaryStep_6: CanaryStep_5
      CanaryStep_7: CanaryStep_6
      CanaryStep_8: CanaryStep_7
      CanaryStep_9: CanaryStep_8
      CanaryStep_10: CanaryStep_9
      CanaryStep_11: CanaryStep_10
      CanaryStep_12: CanaryStep_11
      CanaryStep_13: CanaryStep_12
      CanaryStep_14: CanaryStep_13
      CanaryStep_15: CanaryStep_14
      CanaryStep_16: CanaryStep_15
      CanaryStep_17: CanaryStep_16
      CanaryStep_18: CanaryStep_17
  - name: canaryStabilizationSeconds
    type: number
    default: 900
  - name: canaryStrategyMode
    type: string
    default: Orchestrated
    values:
      - Orchestrated
      - Native
  - name: canaryPreDeployStepsTemplate
    type: string
    default: ""
  - name: canaryPreDeployStepsParameters
    type: object
    default: {}
  - name: canaryRouteTrafficStepsTemplate
    type: string
    default: ""
  - name: canaryRouteTrafficStepsParameters
    type: object
    default: {}
  - name: canaryPostRouteTrafficStepsTemplate
    type: string
    default: ""
  - name: canaryPostRouteTrafficStepsParameters
    type: object
    default: {}
  - name: canarySuccessStepsTemplate
    type: string
    default: ""
  - name: canarySuccessStepsParameters
    type: object
    default: {}
  - name: canaryHealthCheckStepsTemplate
    type: string
    default: ""
  - name: canaryHealthCheckStepsParameters
    type: object
    default: {}
  - name: canaryFailureStepsTemplate
    type: string
    default: ""
  - name: canaryFailureStepsParameters
    type: object
    default: {}
  - name: blueGreenSwapMode
    type: string
    default: Automatic
    values:
      - Automatic
      - Manual
  - name: blueGreenValidationWaitMinutes
    type: number
    default: 5

extends:
  template: /templates/governed-pipeline-base.yml
  parameters:
    productName: ${{ parameters.productName }}
    deployEnvironmentName: ${{ parameters.deployEnvironmentName }}
    buildStepsTemplate: ${{ parameters.buildStepsTemplate }}
    buildStepsParameters:
      imageName: ${{ parameters.imageName }}
      ${{ each pair in parameters.buildStepsParameters }}:
        ${{ pair.key }}: ${{ pair.value }}

    ${{ if eq(parameters.containerDeploymentStrategy, 'Rolling') }}:
      deploymentJobTemplate: /templates/container-workloads/deployment-strategies/rolling-deployment-job.yml
      deploymentJobParameters:
        deployStepsTemplate: ${{ parameters.deployStepsTemplate }}
        deployStepsParameters:
          imageName: ${{ parameters.imageName }}
          rolloutComment: "Rolling deployment triggered by platform template"
          ${{ each pair in parameters.deployStepsParameters }}:
            ${{ pair.key }}: ${{ pair.value }}

    ${{ if eq(parameters.containerDeploymentStrategy, 'Canary') }}:
      deploymentJobTemplate: /templates/container-workloads/deployment-strategies/canary-deployment-job.yml
      deploymentJobParameters:
        deployStepsTemplate: ${{ parameters.deployStepsTemplate }}
        deployStepsParameters:
          imageName: ${{ parameters.imageName }}
          rolloutComment: "Canary deployment triggered by platform template"
          ${{ each pair in parameters.deployStepsParameters }}:
            ${{ pair.key }}: ${{ pair.value }}
        preDeployStepsTemplate: ${{ parameters.canaryPreDeployStepsTemplate }}
        preDeployStepsParameters: ${{ parameters.canaryPreDeployStepsParameters }}
        routeTrafficStepsTemplate: ${{ parameters.canaryRouteTrafficStepsTemplate }}
        routeTrafficStepsParameters: ${{ parameters.canaryRouteTrafficStepsParameters }}
        postRouteTrafficStepsTemplate: ${{ parameters.canaryPostRouteTrafficStepsTemplate }}
        postRouteTrafficStepsParameters: ${{ parameters.canaryPostRouteTrafficStepsParameters }}
        successStepsTemplate: ${{ parameters.canarySuccessStepsTemplate }}
        successStepsParameters: ${{ parameters.canarySuccessStepsParameters }}
        healthCheckStepsTemplate: ${{ parameters.canaryHealthCheckStepsTemplate }}
        healthCheckStepsParameters: ${{ parameters.canaryHealthCheckStepsParameters }}
        failureStepsTemplate: ${{ parameters.canaryFailureStepsTemplate }}
        failureStepsParameters: ${{ parameters.canaryFailureStepsParameters }}
        canaryIncrements: ${{ parameters.canaryIncrements }}
        nativeCanaryIncrements: ${{ parameters.nativeCanaryIncrements }}
        canaryStepDependencyMap: ${{ parameters.canaryStepDependencyMap }}
        stabilizationSeconds: ${{ parameters.canaryStabilizationSeconds }}
        strategyMode: ${{ parameters.canaryStrategyMode }}

    ${{ if eq(parameters.containerDeploymentStrategy, 'BlueGreen') }}:
      deploymentJobTemplate: /templates/container-workloads/deployment-strategies/blue-green-deployment-job.yml
      deploymentJobParameters:
        deployStepsTemplate: ${{ parameters.deployStepsTemplate }}
        deployStepsParameters:
          imageName: ${{ parameters.imageName }}
          rolloutComment: "Blue/Green deployment triggered by platform template"
          ${{ each pair in parameters.deployStepsParameters }}:
            ${{ pair.key }}: ${{ pair.value }}
        swapMode: ${{ parameters.blueGreenSwapMode }}
        validationWaitMinutes: ${{ parameters.blueGreenValidationWaitMinutes }}
