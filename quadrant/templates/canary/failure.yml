parameters:
  - name: productName
    type: string
  - name: deployEnvironmentName
    type: string
  - name: stage
    type: string
    default: failure
  - name: subscriptionId
    type: string
    default: ""
  - name: resourceGroup
    type: string
    default: ""
  - name: containerAppName
    type: string
    default: ""

steps:
  - script: |
      echo "[Quadrant] Canary failed for ${{ parameters.productName }}"
      echo "Environment: ${{ parameters.deployEnvironmentName }}"
      echo "Initiating workload-specific rollback procedures"
    displayName: "Quadrant – failure response"

  - ${{ if ne(parameters.subscriptionId, '') }}:
    - bash: |
      set -euo pipefail
      chmod +x "$(Build.SourcesDirectory)/quadrant/templates/canary/scripts/aca-rollback-traffic.sh"
      "$(Build.SourcesDirectory)/quadrant/templates/canary/scripts/aca-rollback-traffic.sh"
      displayName: "Quadrant – restore ACA traffic"
      env:
        ENTRA_CLIENT_ID: $(ENTRA_CLIENT_ID)
        ENTRA_CLIENT_SECRET: $(ENTRA_CLIENT_SECRET)
        ENTRA_TENANT_ID: $(ENTRA_TENANT_ID)
        ACA_SUBSCRIPTION_ID: ${{ parameters.subscriptionId }}
        ACA_RESOURCE_GROUP: ${{ parameters.resourceGroup }}
        ACA_CONTAINER_APP: ${{ parameters.containerAppName }}
