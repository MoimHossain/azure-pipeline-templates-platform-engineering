parameters:
  - name: productName
    type: string
  - name: deployEnvironmentName
    type: string
  - name: stage
    type: string
    default: preDeploy
  - name: subscriptionId
    type: string
    default: ""
  - name: resourceGroup
    type: string
    default: ""
  - name: containerAppName
    type: string
    default: ""

steps:
  - checkout: self
    displayName: "Quadrant – fetch deployment scripts"

  - script: |
      echo "[Quadrant] Pre-deploy checks for ${{ parameters.productName }}"
      echo "Target environment: ${{ parameters.deployEnvironmentName }}"
    displayName: "Quadrant – pre-deploy guardrails"

  - task: AzureCLI@2
    condition: ne('${{ parameters.subscriptionId }}', '')
    displayName: "Quadrant – configure ACA revision mode"
    inputs:
      azureSubscription: ServicePrincipalForAzDO
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        az containerapp revision set-mode --name "$ACA_CONTAINER_APP" --resource-group "$ACA_RESOURCE_GROUP" --mode multiple
        echo "Revision mode set to 'multiple' for $ACA_CONTAINER_APP"
    env:
      ACA_SUBSCRIPTION_ID: ${{ parameters.subscriptionId }}
      ACA_RESOURCE_GROUP: ${{ parameters.resourceGroup }}
      ACA_CONTAINER_APP: ${{ parameters.containerAppName }}
