parameters:
  - name: productName
    type: string
  - name: deployEnvironmentName
    type: string
  - name: stage
    type: string
    default: routeTraffic
  - name: incrementPercent
    type: number
    default: 0
  - name: subscriptionId
    type: string
  - name: resourceGroup
    type: string
  - name: containerAppName
    type: string
  - name: revisionSuffix
    type: string

steps:
  - checkout: self
    displayName: "Quadrant üîÅ fetch deployment scripts"

  - task: DownloadPipelineArtifact@2
    displayName: "Quadrant üîÅ download canary context"
    inputs:
      artifact: canary-context
      path: $(Pipeline.Workspace)/canary-context

  - task: AzureCLI@2
    displayName: "Quadrant üîÅ route ${{ parameters.incrementPercent }}% via ACA"
    inputs:
      azureSubscription: ServicePrincipalForAzDO
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        set -euo pipefail

        az account set --subscription "$ACA_SUBSCRIPTION_ID"

        context_dir="${PIPELINE_WORKSPACE:-$SYSTEM_DEFAULTWORKINGDIRECTORY}/canary-context"
        context_file="$context_dir/revisions.env"

        if [[ ! -f "$context_file" ]]; then
          echo "##vso[task.logissue type=error]Canary context file not found at ${context_file}"
          exit 1
        fi

        # shellcheck disable=SC1090
        source "$context_file"

        target_weight="${TARGET_WEIGHT:-0}"
        if [[ -z "$target_weight" ]]; then
          target_weight=0
        fi
        if (( target_weight < 0 )); then
          target_weight=0
        fi
        if (( target_weight > 100 )); then
          target_weight=100
        fi

        prod_suffix="${PROD_REV_SUFFIX:-}"
        canary_suffix="${CANARY_REV_SUFFIX:-${ACA_REVISION_SUFFIX:-}}"

        if [[ -z "$prod_suffix" ]]; then
          echo "##vso[task.logissue type=error]PROD_REV_SUFFIX missing from context"
          exit 1
        fi

        if [[ -z "$canary_suffix" ]]; then
          echo "##vso[task.logissue type=error]CANARY_REV_SUFFIX missing from context"
          exit 1
        fi

        prod_revision="${ACA_CONTAINER_APP}--${prod_suffix}"
        canary_revision="${ACA_CONTAINER_APP}--${canary_suffix}"

        prod_weight=$((100 - target_weight))
        if (( prod_weight < 0 )); then
          prod_weight=0
        fi

        echo "[Quadrant] Routing ${target_weight}% to ${canary_revision} and ${prod_weight}% to ${prod_revision}"
        az containerapp ingress traffic set \
          --name "$ACA_CONTAINER_APP" \
          --resource-group "$ACA_RESOURCE_GROUP" \
          --revision-weight "${prod_revision}=${prod_weight}" "${canary_revision}=${target_weight}" \
          >/dev/null
    env:
      ACA_SUBSCRIPTION_ID: ${{ parameters.subscriptionId }}
      ACA_RESOURCE_GROUP: ${{ parameters.resourceGroup }}
      ACA_CONTAINER_APP: ${{ parameters.containerAppName }}
      ACA_REVISION_SUFFIX: ${{ parameters.revisionSuffix }}
      TARGET_WEIGHT: ${{ parameters.incrementPercent }}
